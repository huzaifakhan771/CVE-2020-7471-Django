from django.http import JsonResponse, HttpResponse
from django.contrib.postgres.aggregates import StringAgg
from cve_src.models import Example
import json
from django.forms.models import model_to_dict
from .forms import Inputform
from django.shortcuts import render



def index(request, delimeter):
    try:
        p = Example.objects.aggregate(result=StringAgg('field', delimiter=delimeter))
        return JsonResponse({'Data': p})
    except Exception as error:
        return HttpResponse(error)

def inputform(request):
    if request.method == "GET":
        form = Inputform(request.GET)

        if form.is_valid():
            query = form.data['query']
            results = Example.objects.all().values('label').annotate(concatinated=StringAgg('field', delimiter=query))
            print("RESULTS", results)
            # p = Example.objects.aggregate(result=StringAgg('field', delimiter=query))
            return JsonResponse(list(results), safe=False)

    form = Inputform
    return render(request, 'form.html', {'form': form})